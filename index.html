<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n Pizza</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --supabase-url: 'YOUR_SUPABASE_URL';
            --supabase-key: 'YOUR_SUPABASE_ANON_KEY';
        }
    </style>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .store-selector {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .store-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            color: #333;
        }

        .store-btn:hover {
            border-color: #ff6b35;
            background: #fff5f2;
        }

        .store-btn.active {
            background: #ff6b35;
            color: white;
            border-color: #ff6b35;
        }

        .revenue-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .revenue-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .revenue-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .revenue-amount {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .revenue-card.completed {
            border-left: 4px solid #10b981;
        }

        .revenue-card.pending {
            border-left: 4px solid #f59e0b;
        }

        .revenue-card.total {
            border-left: 4px solid #3b82f6;
        }

        .orders-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .orders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .orders-header h2 {
            font-size: 20px;
            color: #1a1a1a;
        }

        .refresh-btn {
            padding: 8px 16px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #2563eb;
        }

        .orders-grid {
            display: grid;
            gap: 16px;
        }

        .order-card {
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
        }

        .order-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .order-id {
            font-weight: 600;
            font-size: 16px;
            color: #1a1a1a;
        }

        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .order-status.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .order-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .order-info {
            display: grid;
            gap: 8px;
            color: #666;
            font-size: 14px;
        }

        .order-amount {
            font-size: 18px;
            font-weight: 700;
            color: #ff6b35;
            margin-top: 12px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .login-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.login-box {
    background: white;
    padding: 40px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 400px;
}

.login-box h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #1a1a1a;
}

.login-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    margin-bottom: 16px;
    font-size: 15px;
}

.login-input:focus {
    outline: none;
    border-color: #ff6b35;
}

.login-btn {
    width: 100%;
    padding: 12px;
    background: #ff6b35;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 600;
}

.login-btn:hover {
    background: #e55a2b;
}

.login-error {
    color: #c33;
    text-align: center;
    margin-top: 10px;
    font-size: 14px;
}


    </style>
</head>
<body>
    <!-- Th√™m HTML cho m√†n h√¨nh ƒëƒÉng nh·∫≠p (ƒë·∫∑t ngay sau <body>) -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h2>üçï ƒêƒÉng nh·∫≠p</h2>
        <input type="text" id="loginId" class="login-input" placeholder="T√™n ƒëƒÉng nh·∫≠p">
        <input type="password" id="loginPassword" class="login-input" placeholder="M·∫≠t kh·∫©u">
        <button class="login-btn" onclick="handleLogin()">ƒêƒÉng nh·∫≠p</button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>
    <div class="container">
        <div class="header">
                <h1>üçï Qu·∫£n l√Ω ƒê∆°n Pizza</h1>
                <div class="store-selector" id="storeSelector"></div>
            </div>

            <div class="revenue-cards">
                <div class="revenue-card completed">
                    <h3>Doanh thu ƒë√£ th·ª±c hi·ªán</h3>
                    <div class="revenue-amount" id="completedRevenue">0‚Ç´</div>
                </div>
                <div class="revenue-card pending">
                    <h3>Doanh thu ch·ªù</h3>
                    <div class="revenue-amount" id="pendingRevenue">0‚Ç´</div>
                </div>
                <div class="revenue-card total">
                    <h3>T·ªïng doanh thu</h3>
                    <div class="revenue-amount" id="totalRevenue">0‚Ç´</div>
                </div>
            </div>

            <div class="orders-section">
                <div class="orders-header">
                    <h2>ƒê∆°n ch·ªù x·ª≠ l√Ω</h2>
                    <button class="refresh-btn" onclick="loadData()">üîÑ L√†m m·ªõi</button>
                </div>
                <div id="ordersContainer" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
    </div>

    <script>
        // ===== C·∫§U H√åNH SUPABASE - THAY ƒê·ªîI ·ªû ƒê√ÇY =====
        const SUPABASE_URL = 'https://mhmvtywqtaqikaubhhmf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1obXZ0eXdxdGFxaWthdWJoaG1mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNDA4MTMsImV4cCI6MjA3ODYxNjgxM30.VDRLH8sTCkoZfJes3VJfHJhXsaCla9PkM2WcPL5T0Ds';

        // ==============================================

        // Danh s√°ch qu√°n
        const STORES = [
            { id: 'DH', name: 'DH' },
            { id: 'NH', name: 'NH' },
            { id: 'HXH', name: 'HXH' }
        ];

        let supabase;
        let currentStore = 'all';
        let stores = STORES;
        let orders = [];

        // Th√™m v√†o ƒë·∫ßu ph·∫ßn <script>, sau khai b√°o SUPABASE_URL v√† SUPABASE_KEY

// Th√¥ng tin ƒëƒÉng nh·∫≠p (c√≥ th·ªÉ ƒë·ªïi theo √Ω mu·ªën)
const LOGIN_CREDENTIALS = {
    username: 'bomap',
    password: '91932125'
};

function handleLogin() {
    const username = document.getElementById('loginId').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const errorDiv = document.getElementById('loginError');

    if (!username || !password) {
        errorDiv.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin';
        return;
    }

    if (username === LOGIN_CREDENTIALS.username && password === LOGIN_CREDENTIALS.password) {
        // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
        localStorage.setItem('isLoggedIn', 'true');
        document.getElementById('loginScreen').style.display = 'none';
        initApp();
    } else {
        errorDiv.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng';
    }
}

// S·ª≠a l·∫°i h√†m window.onload
window.onload = function() {
    if (localStorage.getItem('isLoggedIn') === 'true') {
        // ƒê√£ ƒëƒÉng nh·∫≠p ‚Üí ·∫©n m√†n h√¨nh login v√† v√†o app
        document.getElementById('loginScreen').style.display = 'none';
        initApp();
    } else {
        // Ch∆∞a ƒëƒÉng nh·∫≠p ‚Üí gi·ªØ nguy√™n m√†n h√¨nh login
        document.getElementById('loginScreen').style.display = 'block';
    }
};

        async function initApp() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Test connection
                const { data, error } = await supabase.from('orders').select('*').limit(1);
                
                if (error) throw error;

                renderStoreSelector();
                await loadData();
                setupRealtimeSubscription();
                
                // Auto refresh every 30 seconds
                setInterval(loadData, 30000);
            } catch (error) {
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="error">L·ªói k·∫øt n·ªëi Supabase: ${error.message}<br>Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh trong code.</div>`;
            }
        }

        function renderStoreSelector() {
            const selector = document.getElementById('storeSelector');
            selector.innerHTML = `
                <button class="store-btn ${currentStore === 'all' ? 'active' : ''}" onclick="selectStore('all')">
                    T·∫•t c·∫£ qu√°n
                </button>
                ${stores.map(store => `
                    <button class="store-btn ${currentStore === store.id ? 'active' : ''}" onclick="selectStore('${store.id}')">
                        ${store.name}
                    </button>
                `).join('')}
            `;
        }

        function selectStore(storeId) {
            currentStore = storeId;
            renderStoreSelector();
            renderOrders();
            updateRevenue();
        }

        async function loadData() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const { data, error } = await supabase
                    .from('orders')
                    .select('*')
                    .gte('created_at', today.toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                orders = data || [];
                renderOrders();
                updateRevenue();
            } catch (error) {
                document.getElementById('ordersContainer').innerHTML = 
                    `<div class="error">L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}</div>`;
            }
        }

        function getStoreName(storeId) {
            const store = stores.find(s => s.id === storeId);
            return store ? store.name : storeId;
        }

        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            
            let filteredOrders = orders;
            if (currentStore !== 'all') {
                filteredOrders = orders.filter(o => o.store_code === currentStore);
            }

            // Ch·ªâ hi·ªÉn th·ªã ƒë∆°n ch·ªù x·ª≠ l√Ω (status !== 'paid')
            filteredOrders = filteredOrders.filter(o => o.status !== 'paid');

            if (filteredOrders.length === 0) {
                container.innerHTML = '<div class="loading">Kh√¥ng c√≥ ƒë∆°n ch·ªù x·ª≠ l√Ω</div>';
                return;
            }

            container.innerHTML = `
                <div class="orders-grid">
                    ${filteredOrders.map(order => {
                        const orderTypeLabel = {
                            'shopee': 'üõçÔ∏è Shopee',
                            'grab': 'üöó Grab',
                            'dine_in': 'üçΩÔ∏è T·∫°i ch·ªó',
                            'takeaway': 'üì¶ Mang ƒëi'
                        }[order.order_type] || order.order_type;

                        const statusLabel = order.status === 'paid' ? 'ƒê√£ thanh to√°n' : 
                                          order.status === 'pending' ? 'Ch·ªù x·ª≠ l√Ω' : 
                                          order.status;

                        const statusClass = order.status === 'paid' ? 'completed' : 'pending';

                        return `
                        <div class="order-card">
                            <div class="order-header">
                                <div class="order-id">#${order.id}</div>
                                <div class="order-status ${statusClass}">
                                    ${order.status === 'paid' ? '‚úì' : '‚è≥'} ${statusLabel}
                                </div>
                            </div>
                            <div class="order-info">
                                <div>üè™ ${order.store_code}</div>
                                <div>${orderTypeLabel}</div>
                                <div>üïê ${new Date(order.created_at).toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</div>
                                ${order.note ? `<div>üìù ${order.note}</div>` : ''}
                            </div>
                            <div class="order-amount">${formatMoney(order.total)}</div>
                        </div>
                    `;
                    }).join('')}
                </div>
            `;
        }

        function updateRevenue() {
    let filteredOrders = orders;

    // L·ªçc theo qu√°n ƒë√∫ng c·ªôt
    if (currentStore !== 'all') {
        filteredOrders = orders.filter(o => o.store_code === currentStore);
    }

    // T·ªïng ƒë√£ thanh to√°n
    const completed = filteredOrders
        .filter(o => o.status === 'paid')
        .reduce((sum, o) => sum + (o.total || 0), 0);

    // T·ªïng ƒë∆°n ch·ªù x·ª≠ l√Ω
    const pending = filteredOrders
        .filter(o => o.status === 'pending')
        .reduce((sum, o) => sum + (o.total || 0), 0);

    document.getElementById('completedRevenue').textContent = formatMoney(completed);
    document.getElementById('pendingRevenue').textContent = formatMoney(pending);
    document.getElementById('totalRevenue').textContent = formatMoney(completed + pending);
}

        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function setupRealtimeSubscription() {
            supabase
                .channel('orders_channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'orders' },
                    () => loadData()
                )
                .subscribe();
        }

 
    </script>
</body>
</html>
